<script>

    class DayReflectionData {
        date;
        weekday;
        milliseconds;
        questions;
        inputs;
        todoLists;
        vision;
        customQuestion;
        counter;

        constructor() {
            this.date = getCurrentDate();
            let days = ["sunday", "monday", "tuesday", "wednesday", "thursday", "friday", "saturday"];
            this.weekday = days[new Date().getDay()];
            this.milliseconds = (new Date()).getTime();
            this.questions = {};
            this.inputs = {};
            this.todoLists = {};
            this.vision = null;
            this.customQuestion = null;
            this.counter = 1;
        }

        loadSavedData(string) {
            let parsed = JSON.parse(string);
            this.date = parsed.date;
            this.weekday = parsed.weekday;
            this.milliseconds = parsed.milliseconds;
            this.questions = parsed.questions;
            this.inputs = parsed.inputs;
            this.todoLists = parsed.todoLists;
            this.vision = parsed.vision;
            this.customQuestion = parsed.customQuestion;
            this.counter = parsed.counter;
        }
    }

    class WeekReflectionData {
        date;
        milliseconds;
        userDataField;
        previousVision;
        vision;
        customQuestion;
        goodStuff;
        badStuff;
        ratings;
        todoLists;
        questions;
        counter;

        constructor() {
            this.date = getCurrentDate();
            this.milliseconds = (new Date()).getTime();
            this.userDataField = "week1";
            this.previousVision = "";
            this.vision = "";
            this.customQuestion = "";
            this.goodStuff = [];
            this.badStuff = [];
            this.ratings = {};
            this.todoLists = {};
            this.questions = {};
            this.counter = 0;
        }

        loadSavedData(string) {
            if (string) {
                let parsed = string;
                this.date = parsed.date;
                this.milliseconds = parsed.milliseconds;
                this.userDataField = parsed.userDataField;
                this.previousVision = parsed.previousVision;
                this.vision = parsed.vision;
                this.customQuestion = parsed.customQuestion;
                this.goodStuff = parsed.goodStuff;
                this.badStuff = parsed.badStuff;
                this.ratings = parsed.ratings;
                this.todoLists = parsed.todoLists;
                this.questions = parsed.questions;
                this.counter = parsed.counter;
            } else {
                this.userDataField = "";
                this.date = null;
                this.milliseconds = null;
                this.counter = null;
            }
        }

    }

    class GoodOrBadStuff {
        text;
        class;
        prompt;
        weekDay;

        constructor(textValue, classValue, promptValue, weekDayValue) {
            this.text = textValue;
            this.class = classValue;
            this.prompt = promptValue;
            this.weekDay = weekDayValue;
        }
    }

    class todoListItem {
        text;
        class;

        constructor(textValue, classValue) {
            this.text = textValue;
            this.class = classValue;
        }
    }

    function cyrb128(str) {
        let h1 = 1779033703, h2 = 3144134277,
            h3 = 1013904242, h4 = 2773480762;
        for (let i = 0, k; i < str.length; i++) {
            k = str.charCodeAt(i);
            h1 = h2 ^ Math.imul(h1 ^ k, 597399067);
            h2 = h3 ^ Math.imul(h2 ^ k, 2869860233);
            h3 = h4 ^ Math.imul(h3 ^ k, 951274213);
            h4 = h1 ^ Math.imul(h4 ^ k, 2716044179);
        }
        h1 = Math.imul(h3 ^ (h1 >>> 18), 597399067);
        h2 = Math.imul(h4 ^ (h2 >>> 22), 2869860233);
        h3 = Math.imul(h1 ^ (h3 >>> 17), 951274213);
        h4 = Math.imul(h2 ^ (h4 >>> 19), 2716044179);
        return [(h1 ^ h2 ^ h3 ^ h4) >>> 0, (h2 ^ h1) >>> 0, (h3 ^ h1) >>> 0, (h4 ^ h1) >>> 0];
    }

    function sfc32(a, b, c, d) {
        return function () {
            a >>>= 0;
            b >>>= 0;
            c >>>= 0;
            d >>>= 0;
            var t = (a + b) | 0;
            a = b ^ b >>> 9;
            b = c + (c << 3) | 0;
            c = (c << 21 | c >>> 11);
            d = d + 1 | 0;
            t = t + d | 0;
            c = c + t | 0;
            return (t >>> 0) / 4294967296;
        }
    }


    function populateWeightedQuestions(questions, weights) {
        var weightedQuestions = [];

        for (var i = 0; i < questions.length; i++) {
            for (var j = 0; j < weights[i]; j++) {
                weightedQuestions.push(questions[i]);
            }
        }
        return weightedQuestions;
    }

    function getRandomQuestion(questions, weights) {
        var weightedQuestions = populateWeightedQuestions(questions, weights)
        return weightedQuestions[Math.floor(Math.random() * weightedQuestions.length)];
    }

    function setQuestion(week, day, question, selector) {
        setQuestionData(question, selector);
    }

    function setQuestionData(question, selector) {
        weekData.questions[selector] = question;
    }

    function setQuestionsInHTML() {
        for (let [key, value] of Object.entries(weekData.questions)) {
            const elements = document.querySelectorAll('[question="' + key + '"]');
            elements.forEach(function (element) {
                element.innerHTML = value;
            })

        }
    }

    function setRandomQuestion(week, day, questions, weights, selector) {
        const question = getRandomQuestion(questions, weights);
        setQuestion(week, day, question, selector);
    }

    function setRandomQuestionPair(week, day, questions, questions2, weights, selector, selector2) {
        var weightedQuestions = populateWeightedQuestions(questions, weights);
        var weightedQuestions2 = populateWeightedQuestions(questions2, weights);

        var randomNumber = Math.floor(Math.random() * weightedQuestions.length);
        setQuestion(week, day, weightedQuestions[randomNumber], selector);
        setQuestion(week, day, weightedQuestions2[randomNumber], selector2);
    }

    function randomizeQuestions(week, day) {

        var questions = [];
        var weights = [];
        questions.push("For whose contribution to this week am I especially grateful?");
        weights.push(1);
        questions.push("Which aspect of the last week do I feel the most grateful for right now, and why?");
        weights.push(1);
        questions.push("What positive thoughts and emotions do I have when reflecting on all the positive aspects of the last week?");
        weights.push(1);
        questions.push("What small, joyful moments from the past week am I particularly thankful for?");
        weights.push(1);
        questions.push("What experience from last week contributed to my personal growth, and why am I thankful for it?");
        weights.push(1);
        questions.push("Was there any unexpected pleasure last week? Why am I grateful for this surprise?");
        weights.push(1);
        questions.push("Which leisure activity from the past week am I most grateful for, and why?");
        weights.push(1);

        setRandomQuestion(week, day, questions, weights, "grateful");

        questions = [];
        weights = [];
        questions.push("What steps should I take to repeat these successes next week?");
        weights.push(1);
        questions.push("What habits do I need to maintain to ensure next week is similarly good?");
        weights.push(1);
        questions.push("How can I make sure to repeat these positive aspects next week?");
        weights.push(1);
        questions.push("What did I do to encourage these positive moments, and how can I repeat that next week?");
        weights.push(1);
        questions.push("What can I learn from this week's highlights to make next week equally successful?");
        weights.push(1);
        questions.push("Which joyful experiences can I plan for next week?");
        weights.push(1);
        questions.push("How can I continue to nurture the relationships that contributed to this week's success?");
        weights.push(1);
        questions.push("What strategies worked well for overcoming challenges this week, and how can I apply them next week?");
        weights.push(1);
        questions.push("What actions did I take for my well-being this week that I should prioritize next week?");
        weights.push(1);
        questions.push("What personal growth did I achieve this week, and how can I continue this trajectory?");
        weights.push(1);

        setRandomQuestion(week, day, questions, weights, "repeat");

        questions = [];
        weights = [];
        questions.push("Take 3 minutes to rant about everything that went wrong this week. Let it all out:");
        weights.push(1);
        questions.push("If I had permission to behave like a toddler throwing a tantrum, what would I do and say in response to this week's hardships?");
        weights.push(1);
        questions.push("Spend a moment complaining about why all of this seems unfair. We'll become more constructive soon, but for now, focus on expressing your frustration:");
        weights.push(1);
        questions.push("What are the things you've been holding in that you really need to vent about from this past week?");
        weights.push(1);
        questions.push("What were the small irritations and annoyances of the week? Feel free to list them all:");
        weights.push(1);
        questions.push("In what ways did this week not meet my expectations? Describe the feelings of disappointment:");
        weights.push(1);
        questions.push("Think about any frustrating interactions I had. What would I like to say about them?");
        weights.push(1);
        questions.push("What challenges felt overwhelming this week?");
        weights.push(1);
        questions.push("Are there any unresolved issues from this week that are still bothering me?");
        weights.push(1);
        questions.push("Identify what or who drained my energy this week and express how that made me feel:");
        weights.push(1);


        setRandomQuestion(week, day, questions, weights, "complain");

        questions = [];
        weights = [];
        questions.push("How can I improve the areas that were neglected this week?");
        weights.push(1);
        questions.push("What could I have done to prevent the problems I faced this week, and how can I apply these lessons next week?");
        weights.push(1);
        questions.push("What was last week's biggest problem, and how can I ensure it doesn't limit me next week?");
        weights.push(1);
        questions.push("Reflecting on last week, what mistakes did I make and what have I learned from them to do better next week?");
        weights.push(1);
        questions.push("What specific strategies can I implement to overcome the challenges I encountered last week?");
        weights.push(1);
        questions.push("Who or what could provide support or assistance in areas where I struggled last week?");
        weights.push(1);
        questions.push("How might I need to adjust my goals or expectations for next week based on what I've learned?");
        weights.push(1);
        questions.push("What is my plan of action to address the key issues I faced last week?");
        weights.push(1);
        questions.push("How can I better manage my time next week to avoid the pitfalls of the last week?");
        weights.push(1);
        questions.push("How can I be more flexible or adaptable in situations like those I faced last week?");
        weights.push(1);
        questions.push("From whom can I seek feedback to improve in areas where I struggled?");
        weights.push(1);


        setRandomQuestion(week, day, questions, weights, "improve");
    }

    function initRandom(randomSeed) {
// Create cyrb128 state:
        var seed = cyrb128(randomSeed);
// Four 32-bit component hashes provide the seed for sfc32.
        var rand = sfc32(seed[0], seed[1], seed[2], seed[3]);
        Math.random = rand;
    }

    function getCurrentDate() {
        var today = new Date();
        var dd = String(today.getDate()).padStart(2, '0');
        var mm = String(today.getMonth() + 1).padStart(2, '0'); //January is 0!
        var yyyy = today.getFullYear();

        return dd + '-' + mm + '-' + yyyy;
    }

    const addInputHighlight = document.querySelector("#wf-form-Add-Form-highlight");
    const todoListHighlight = document.querySelector("#todo-middle-area-highlight");
    const addInputLowlight = document.querySelector("#wf-form-Add-Form-lowlight");
    const todoListLowlight = document.querySelector("#todo-middle-area-lowlight");
    const addInputGoodGrateful = document.querySelector("#wf-form-Add-Form-Good-Grateful");
    const todoListGoodGrateful = document.querySelector("#todo-middle-area-good-grateful");
    const addInputGoodRepeat = document.querySelector("#wf-form-Add-Form-Good-Repeat");
    const todoListGoodRepeat = document.querySelector("#todo-middle-area-good-repeat");
    const addInputBadComplain = document.querySelector("#wf-form-Add-Form-Bad-Complain");
    const todoListBadComplain = document.querySelector("#todo-middle-area-bad-complain");
    const addInputBadImprove = document.querySelector("#wf-form-Add-Form-Bad-Improve");
    const todoListBadImprove = document.querySelector("#todo-middle-area-bad-improve");
    const addInputCalendar = document.querySelector("#wf-form-Add-Form-Calendar");
    const todoListCalendar = document.querySelector("#todo-middle-area-calendar");
    const addInputOld = document.querySelector("#wf-form-Add-Form-Old");
    const todoListOld = document.querySelector("#todo-middle-area-old");
    const addInputNextWeek = document.querySelector("#wf-form-Add-Form-Next-Week");
    const todoListNextWeek = document.querySelector("#todo-middle-area-next-week");
    const addInputImproveGoals = document.querySelector("#wf-form-Add-Form-Improve-Goals");
    const todoListImproveGoals = document.querySelector("#todo-middle-area-improve-goals");
    const todoInputsWithPrompt = [addInputHighlight, addInputLowlight];
    const todoListsWithPrompt = [todoListHighlight, todoListLowlight];
    const todoInputsDeletable = [addInputGoodGrateful, addInputGoodRepeat, addInputBadComplain, addInputBadImprove, addInputCalendar, addInputNextWeek, addInputImproveGoals];
    const todoListsDeletable = [todoListGoodGrateful, todoListGoodRepeat, todoListBadComplain, todoListBadImprove, todoListCalendar, todoListNextWeek, todoListImproveGoals];
    const todoInputsNonDeletable = [addInputOld];
    const todoListsNonDeletable = [todoListOld];

    const ratingFormPreviousVision = document.querySelector("#rating-previous-vision");
    const ratingFormSleep = document.querySelector("#rating-sleep");
    const ratingFormNutrition = document.querySelector("#rating-nutrition");
    const ratingFormPhysicalHealth = document.querySelector("#rating-physical");
    const ratingFormMentalHealth = document.querySelector("#rating-mental");
    const ratingFormLove = document.querySelector("#rating-love");
    const ratingFormFamily = document.querySelector("#rating-family");
    const ratingFormFriends = document.querySelector("#rating-friends");
    const ratingFormMission = document.querySelector("#rating-mission");
    const ratingFormFun = document.querySelector("#rating-fun");
    const ratingFormFinances = document.querySelector("#rating-finances");
    const ratingFormLearning = document.querySelector("#rating-learning");
    const ratingForms = [ratingFormPreviousVision, ratingFormSleep, ratingFormNutrition, ratingFormPhysicalHealth,
        ratingFormMentalHealth, ratingFormLove, ratingFormFamily, ratingFormFriends, ratingFormMission, ratingFormFun,
        ratingFormFinances, ratingFormLearning];


    function updateTodoListData(list) {
        let listSelector = list.id;
        let items = list.querySelectorAll(".todo-label");
        let values = [];
        items.forEach(function (item) {
            let classList = Array.from(item.parentElement.classList);
            classList.shift();
            values.push(new todoListItem(item.innerHTML, classList));
        });
        weekData.todoLists[listSelector] = values;
        if (listSelector === "todo-middle-area-highlight") {
            weekData.goodStuff = values;
        } else if (listSelector === "todo-middle-area-lowlight") {
            weekData.badStuff = values;
        }
    }

    function disableAutoComplete(input) {
        input.setAttribute("autocomplete", "off");
    }

    function updateGoodStuffData(list) {
        let listSelector = list.id;
        let items = list.querySelectorAll(".todo_item");
        let values = [];
        items.forEach(function (item) {
            let classList = Array.from(item.classList);
            classList.shift();
            values.push(new GoodOrBadStuff(item.querySelector(".central-text").innerText, classList, item.querySelector(".top-text").innerText, item.querySelector(".bottom-text").innerText));
        });
        weekData.goodStuff = values;
    }

    function updateBadStuffData(list) {
        let listSelector = list.id;
        let items = list.querySelectorAll(".todo_item");
        let values = [];
        items.forEach(function (item) {
            let classList = Array.from(item.classList);
            classList.shift();
            values.push(new GoodOrBadStuff(item.querySelector(".central-text").innerText, classList, item.querySelector(".top-text").innerText, item.querySelector(".bottom-text").innerText));
        });
        weekData.badStuff = values;
    }

    const addTodoGoodBadStuff = (list, todo, classString, prompt, weekday) => {
        let classStringTotal = "todo_item";
        if (classString) {
            classStringTotal += " " + classString;
        }
        const htmlContent = `
             <div class="${classStringTotal}">
                <img class="task-image"/>
                <div class="text-flex">
                    <div class="top-text">${prompt}</div>
                    <div class="central-text">${todo}</div>
                    <div class="bottom-text">${weekday}</div>
                </div>
                <div class="svg-icon trash-icon w-embed">
                  <img src="https://uploads-ssl.webflow.com/60c4d225dfa29d5ab66cd5d8/65be97052cbe8725d5ba8662_trash3.svg" loading="lazy" alt="" class="svg-icon trash-icon pointer-none">
                </div>
              </div>
`;
        list.innerHTML += htmlContent;
    };

    const addTodoDeletable = (list, todo, classString) => {
        let classStringTotal = "todo_item";
        if (classString) {
            classStringTotal += " " + classString;
        }
        const htmlContent = `
             <div class="${classStringTotal}">
                <div class="pointer-none todo-label">${todo}</div>
                <img class="task-image"/>
                <div class="svg-icon trash-icon w-embed">
                  <img src="https://uploads-ssl.webflow.com/60c4d225dfa29d5ab66cd5d8/65be97052cbe8725d5ba8662_trash3.svg" loading="lazy" alt="" class="svg-icon trash-icon pointer-none">
                </div>
              </div>
`;
        list.innerHTML += htmlContent;
    };
    const addTodoNonDeletable = (list, todo, classString) => {
        let classStringTotal = "todo_item";
        if (classString) {
            classStringTotal += " " + classString;
        }
        const htmlContent = `
             <div class="${classStringTotal}">
                <div class="pointer-none todo-label">${todo}</div>
                <img class="task-image"/>
              </div>
`;
        list.innerHTML += htmlContent;
    };

    const inputsForBacklog = [addInputGoodRepeat, addInputBadImprove, addInputCalendar];

    //add item on submit deletable
    todoInputsDeletable.forEach(function (element, index) {
        disableAutoComplete(element.AddTerm);
        element.addEventListener("submit", (e) => {
            e.preventDefault();
            const input = element.AddTerm.value.trim();

            if (input.length) {
                addTodoDeletable(todoListsDeletable[index], input);
                updateTodoListData(todoListsDeletable[index]);
                if (inputsForBacklog.includes(todoInputsDeletable[index])) {
                    addTodoDeletable(todoListNextWeek, input);
                    updateTodoListData(todoListNextWeek);
                }
                element.reset();
            }
        });
    });

    //add item on submit deletable with prompt for high and lowlights
    todoInputsWithPrompt.forEach(function (element, index) {
        disableAutoComplete(element.AddTerm);
        element.addEventListener("submit", (e) => {
            e.preventDefault();
            const input = element.AddTerm.value.trim();

            if (input.length) {
                addTodoGoodBadStuff(todoListsWithPrompt[index], input, null, "General:", "This week");
                if (todoListsWithPrompt[index] === todoListHighlight) {
                    updateGoodStuffData(todoListHighlight);
                } else if (todoListsWithPrompt[index] === todoListLowlight) {
                    updateBadStuffData(todoListLowlight);
                }
                element.reset();
            }
        });
    });

    //add item on submit non deletable
    todoInputsNonDeletable.forEach(function (element, index) {
        disableAutoComplete(element.AddTerm);
        element.addEventListener("submit", (e) => {
            e.preventDefault();
            const input = element.AddTerm.value.trim();

            if (input.length) {
                addTodoNonDeletable(todoListsNonDeletable[index], input);
                updateTodoListData(todoListsNonDeletable[index]);
                element.reset();
            }
        });
    });

    //add item on blur deletable
    todoInputsDeletable.forEach(function (element, index) {
        element.AddTerm.onblur = function () {
            const input = element.AddTerm.value.trim();
            if (input.length) {
                todoInputsDeletable[index].requestSubmit();
            }
        }
    });

    //add item on blur non deletable
    todoInputsNonDeletable.forEach(function (element, index) {
        element.AddTerm.onblur = function () {
            const input = element.AddTerm.value.trim();
            if (input.length) {
                todoInputsNonDeletable[index].requestSubmit();
            }
        }
    });

    //add item on blur with prompt
    todoInputsWithPrompt.forEach(function (element, index) {
        element.AddTerm.onblur = function () {
            const input = element.AddTerm.value.trim();
            if (input.length) {
                todoInputsWithPrompt[index].requestSubmit();
            }
        }
    });

    //delete items
    todoListsDeletable.forEach(function (element, index) {
        element.addEventListener("click", (e) => {
            let deletedItem = null;
            if (e.target.parentElement.parentElement.classList.contains("trash-icon")) {
                deletedItem = e.target.parentElement.parentElement.parentElement.querySelector(".todo-label").innerHTML.trim();
                e.target.parentElement.parentElement.parentElement.remove();
                updateTodoListData(todoListsDeletable[index]);
            } else if (e.target.parentElement.classList.contains("trash-icon")) {
                deletedItem = e.target.parentElement.parentElement.querySelector(".todo-label").innerHTML.trim();
                e.target.parentElement.parentElement.remove();
                updateTodoListData(todoListsDeletable[index]);
            } else if (e.target.classList.contains("trash-icon")) {
                deletedItem = e.target.parentElement.querySelector(".todo-label").innerHTML.trim();
                e.target.parentElement.remove();
                updateTodoListData(todoListsDeletable[index]);
            }

            // if an item that landed on the list for next week was deleted, delete it there as well, also on the final list
            if (deletedItem && inputsForBacklog.includes(todoInputsDeletable[index])) {
                for (const a of todoListNextWeek.querySelectorAll(".todo_item")) {
                    if (a.children[0].textContent === deletedItem) {
                        a.parentElement.removeChild(a);
                        updateTodoListData(todoListNextWeek);
                    }
                }
                for (const a of todoListImproveGoals.querySelectorAll(".todo_item")) {
                    if (a.children[0].textContent === deletedItem) {
                        a.parentElement.removeChild(a);
                        updateTodoListData(todoListImproveGoals);
                    }
                }
            }
        });
    });

    //delete items for prompt list
    todoListsWithPrompt.forEach(function (element, index) {
        element.addEventListener("click", (e) => {
            if (e.target.parentElement.parentElement.classList.contains("trash-icon")) {
                e.target.parentElement.parentElement.parentElement.remove();
                updateTodoListData(todoListsWithPrompt[index]);
            } else if (e.target.parentElement.classList.contains("trash-icon")) {
                e.target.parentElement.parentElement.remove();
                updateTodoListData(todoListsWithPrompt[index]);
            } else if (e.target.classList.contains("trash-icon")) {
                e.target.parentElement.remove();
                updateTodoListData(todoListsWithPrompt[index]);
            }
        });
    });

    ratingForms.forEach(function (element, index) {
        element.addEventListener("click", (e) => {
            if (e.target.tagName.toLowerCase() === "input") {
                let ratingSelector = e.target.getAttribute('data-name');
                weekData.ratings[ratingSelector] = e.target.getAttribute('value');
                //show or hide the respective element on the summary pages, adjust the number
                //find the good and bad elements, update the value, hide them all
                let elementsGood = document.querySelectorAll('[ratingGood="' + ratingSelector.toLowerCase() + '"]');
                let elementsBad = document.querySelectorAll('[ratingBad="' + ratingSelector.toLowerCase() + '"]');
                elementsGood.forEach(function (item) {
                    item.querySelector(".rating-element").innerHTML = weekData.ratings[ratingSelector];
                    item.classList.add("hidden");
                });
                elementsBad.forEach(function (item) {
                    item.querySelector(".rating-element").innerHTML = weekData.ratings[ratingSelector];
                    item.classList.add("hidden");
                });
                //if within range, show on respective page
                if (weekData.ratings[ratingSelector] > 6) {
                    elementsGood.forEach(function (item) {
                        item.classList.remove("hidden");
                    });
                } else if (weekData.ratings[ratingSelector] < 5) {
                    elementsBad.forEach(function (item) {
                        item.classList.remove("hidden");
                    });
                }

            }
        })
    });

    //Cross out done tasks and update the backlog accordingly
    todoListOld.addEventListener("click", (e) => {
        let todo = "";
        if (e.target.classList.contains("todo_item")) {
            e.target.classList.toggle("is-done");
            updateTodoListData(todoListOld);
            todo = e.target.firstElementChild.innerHTML;
        } else if (e.target.parentElement.classList.contains("todo_item")) {
            e.target.parentElement.classList.toggle("is-done");
            updateTodoListData(todoListOld);
            todo = e.target.innerHTML;
        }
        // remove from the backlog tasks
        if (e.target.classList.contains("is-done") || e.target.parentElement.classList.contains("is-done")) {
            for (const a of todoListNextWeek.querySelectorAll(".todo_item")) {
                if (a.children[0].textContent === todo) {
                    a.parentElement.removeChild(a);
                    updateTodoListData(todoListNextWeek);
                }
            }
            // add to today's tasks
        } else {
            addTodoDeletable(todoListNextWeek, todo);
        }
        updateTodoListData(todoListNextWeek);

    });

    //Select next weeks tasks and add them to the final list
    todoListNextWeek.addEventListener("click", (e) => {
        let todo = "";
        if (e.target.classList.contains("todo_item")) {
            e.target.classList.toggle("is-next-weeks-task");
            updateTodoListData(todoListNextWeek);
            todo = e.target.firstElementChild.innerHTML;
        } else if (e.target.parentElement.classList.contains("todo_item")) {
            e.target.parentElement.classList.toggle("is-next-weeks-task");
            updateTodoListData(todoListNextWeek);
            todo = e.target.innerHTML;
        }
        // add to the final tasks
        if (e.target.classList.contains("is-next-weeks-task") || e.target.parentElement.classList.contains("is-next-weeks-task")) {
            addTodoDeletable(todoListImproveGoals, todo);
            updateTodoListData(todoListImproveGoals);
            // remove from the final list
        } else {
            for (const a of todoListImproveGoals.querySelectorAll(".todo_item")) {
                if (a.children[0].textContent === todo) {
                    a.parentElement.removeChild(a);
                    updateTodoListData(todoListImproveGoals);
                }
            }
        }
        updateTodoListData(todoListImproveGoals);

    });

    //finalize goals and mark them for next week
    todoListImproveGoals.addEventListener("click", (e) => {
        let todo = "";
        if (e.target.classList.contains("todo_item")) {
            e.target.classList.toggle("is-finalized-task");
            updateTodoListData(todoListImproveGoals);
            todo = e.target.firstElementChild.innerHTML;
        } else if (e.target.parentElement.classList.contains("todo_item")) {
            e.target.parentElement.classList.toggle("is-finalized-task");
            updateTodoListData(todoListImproveGoals);
            todo = e.target.innerHTML;
        }

    });

    /* //Mark as today's task
     todoListToday.addEventListener("click", (e) => {
         if (e.target.classList.contains("todo_item")) {
             e.target.classList.toggle("is-todays-task");
             updateTodoListData(todoListToday);
         } else if (e.target.parentElement.classList.contains("todo_item")) {
             e.target.parentElement.classList.toggle("is-todays-task");
             updateTodoListData(todoListToday);
         }
     });*/

    //mark as highlight
    todoListHighlight.addEventListener("click", (e) => {
        const isTrashIconClick = e.target.closest(".trash-icon");

        if (!isTrashIconClick) {
            const todoItem = e.target.closest(".todo_item");

            if (todoItem) {
                let text = todoItem.querySelector(".central-text").innerHTML;
                if (todoItem.classList.contains("is-highlight")) {
                    // remove the item from GoodStuff Summary Fields
                    let summaries = document.querySelectorAll(".goodsummary");
                    summaries.forEach(function (summary) {
                        summary.querySelectorAll(".central-text").forEach(function (item) {
                            if (item.innerHTML.trim() === text) {
                                item.remove();
                                if (!document.querySelectorAll(".goodsummary")[0].innerText.trim()) {
                                    document.querySelectorAll(".goodsummary").forEach(function (summary) {
                                        summary.classList.add("hidden");
                                    });
                                }
                            }
                        });
                    });
                } else {
                    // add the item from GoodStuff Summary Fields
                    let summaries = document.querySelectorAll(".goodsummary");
                    summaries.forEach(function (summary) {
                        const htmlContent = `
             <div class="central-text">
                ${text}
              </div>
`;
                        summary.innerHTML += htmlContent;
                    });
                    document.querySelectorAll(".goodsummary").forEach(function (summary) {
                            summary.classList.remove("hidden");
                    });
                }
                todoItem.classList.toggle("is-highlight");
                updateGoodStuffData(todoListHighlight);
            }
        }
    });

    //mark as lowlight
    todoListLowlight.addEventListener("click", (e) => {
        const isTrashIconClick = e.target.closest(".trash-icon");

        if (!isTrashIconClick) {
            const todoItem = e.target.closest(".todo_item");

            if (todoItem) {
                let text = todoItem.querySelector(".central-text").innerHTML;
                if (todoItem.classList.contains("is-lowlight")) {
                    // remove the item from BadStuff Summary Fields
                    let summaries = document.querySelectorAll(".badsummary");
                    summaries.forEach(function (summary) {
                        summary.querySelectorAll(".central-text").forEach(function (item) {
                            if (item.innerHTML.trim() === text) {
                                item.remove();
                                if (!document.querySelectorAll(".badsummary")[0].innerText.trim()) {
                                    document.querySelectorAll(".badsummary").forEach(function (summary) {
                                        summary.classList.add("hidden");
                                    });
                                }
                            }
                        });
                    });
                } else {
                    // add the item from BadStuff Summary Fields
                    let summaries = document.querySelectorAll(".badsummary");
                    summaries.forEach(function (summary) {
                        const htmlContent = `
             <div class="central-text">
                ${text}
              </div>
`;
                        summary.innerHTML += htmlContent;
                    });
                    document.querySelectorAll(".badsummary").forEach(function (summary) {
                        summary.classList.remove("hidden");
                    });
                }
                todoItem.classList.toggle("is-lowlight");
                updateBadStuffData(todoListLowlight);
            }
        }
    });

    //clickhandler for the buttons


    function waitFor(conditionFunction) {
        let maxTries = 10;
        let currentTry = 0;
        const poll = resolve => {
            if (conditionFunction()) resolve();
            else if (currentTry < maxTries) {
                currentTry = currentTry + 1;
                setTimeout(_ => poll(resolve), 500);
            } else {
                console.log("user data not found, probably triggered webflows maximum request. Using cookie data instead")
                resolve();
            }
        }
        return new Promise(poll);
    }

    function waitForElm(element) {
        return new Promise(resolve => {
            if (element) {
                return resolve(element);
            }

            const observer = new MutationObserver(mutations => {
                if (element) {
                    resolve(element);
                    observer.disconnect();
                }
            });

            observer.observe(document.body, {
                childList: true,
                subtree: true
            });
        });
    }

    function setRatings() {
        for (let [key, value] of Object.entries(weekData.ratings)) {
            document.querySelector("[data-name='" + key + "'][value='" + value + "']").parentElement.querySelector("div").classList.add("w--redirected-checked");
            //find the good and bad elements, update the value, hide them all
            let elementsGood = document.querySelectorAll('[ratingGood="' + key.toLowerCase() + '"]');
            let elementsBad = document.querySelectorAll('[ratingBad="' + key.toLowerCase() + '"]');
            elementsGood.forEach(function (item) {
                item.querySelector(".rating-element").innerHTML = weekData.ratings[key];
                item.classList.add("hidden");
            });
            elementsBad.forEach(function (item) {
                item.querySelector(".rating-element").innerHTML = weekData.ratings[key];
                item.classList.add("hidden");
            });
            //if within range, show on respective page
            if (weekData.ratings[key] > 6) {
                elementsGood.forEach(function (item) {
                    item.classList.remove("hidden");
                });
            } else if (weekData.ratings[key] < 5) {
                elementsBad.forEach(function (item) {
                    item.classList.remove("hidden");
                });
            }
        }
    }

    function setTodoItems() {
// dayData has a list of todoLists based on selectors. create a method that
        // adds a new item to a todolist without writing it to data. also consider the state of the todo
        for (let [key, value] of Object.entries(weekData.todoLists)) {
            let element = document.querySelector("#" + key);
            value.forEach(function (item) {
                if (todoListsDeletable.includes(element)) {
                    addTodoDeletable(element, item.text, item.class[0]);
                } else if (todoListsNonDeletable.includes(element)) {
                    addTodoNonDeletable(element, item.text, item.class[0]);
                } else if (todoListsWithPrompt.includes(element)) {
                    addTodoGoodBadStuff(element, item.text, item.class[0], item.prompt, item.weekday);
                }
            });
        }
        weekData.goodStuff.forEach(goodStuff => {
            if (goodStuff.class[0]) {
                // add the item from GoodStuff Summary Fields
                let summaries = document.querySelectorAll(".goodsummary");
                summaries.forEach(function (summary) {
                    const htmlContent = `
             <div class="central-text">
                ${goodStuff.text}
              </div>
`;
                    summary.innerHTML += htmlContent;
                });
            }
        });
        //if no good stuff, adjust header
        if (weekData.goodStuff.length < 1) {
            document.querySelector("#highlights-header").innerHTML = "Write down all the good stuff that happened this week. Mark your personal highlights:";
        }

        weekData.badStuff.forEach(badStuff => {
            if (badStuff.class[0]) {
                // add the item from BadStuff Summary Fields
                let summaries = document.querySelectorAll(".badsummary");
                summaries.forEach(function (summary) {
                    const htmlContent = `
             <div class="central-text">
                ${badStuff.text}
              </div>
`;
                    summary.innerHTML += htmlContent;
                });
            }
        });
        //if no bad stuff, adjust header
        if (weekData.badStuff.length < 1) {
            document.querySelector("#lowlights-header").innerHTML = "Write down all the bad stuff that happened this week. Mark your personal lowlights:";
        }


    }

    function setGoodAndBadStuff(todoAreaID, stuffList) {
        let element = document.querySelector("#" + todoAreaID);
        stuffList.forEach(function (item) {
            addTodoGoodBadStuff(element, item.text, item.class[0], item.prompt, item.weekDay);
        });

    }

    function onVisible(element, callback) {
        new IntersectionObserver((entries, observer) => {
            entries.forEach(entry => {
                if (entry.intersectionRatio > 0) {
                    callback(element);
                    observer.disconnect();
                }
            });
        }).observe(element);
    }

    function setTextareas() {
//       //set the vision and the custom question
        let textAreaVision = document.querySelector("textarea[textarea='vision']");
        let textAreaCustom = document.querySelector("textarea[textarea='custom']");
        textAreaVision.value = weekData.vision;
        textAreaCustom.value = weekData.customQuestion;
        onVisible(textAreaVision, (element) => {
                console.log("it's visible");
                element.style.height = 'auto';
                element.style.height = element.scrollHeight + 16 + 'px';
            }
        );
        onVisible(textAreaCustom, (element) => {
                console.log("it's visible");
                element.style.height = 'auto';
                element.style.height = element.scrollHeight + 16 + 'px';
            }
        );
        textAreaVision.addEventListener('input', saveToData, false);
        textAreaCustom.addEventListener('input', saveToData, false);

    }

    function setCounter() {
        document.querySelector("#final-counter").innerHTML = weekData.counter;
        if (weekData.counter === 1) {
            document.querySelector(".counter-text").innerHTML = "week in a row!";
        }
    }

    function clearTodoItems() {
        //clear all todolists so I can keep them filled to test the styling
        todoListsDeletable.forEach(function (todoList) {
                todoList.innerHTML = "";
            }
        );
        todoListsNonDeletable.forEach(function (todoList) {
                todoList.innerHTML = "";
            }
        );

        todoListsWithPrompt.forEach(function (todoList) {
                todoList.innerHTML = "";
            }
        );
    }

    function parseDateString(dateString) {
        var dateParts = dateString.split("-");
// month is 0-based, that's why we need dataParts[1] - 1
        var dateObject = new Date(+dateParts[2], dateParts[1] - 1, +dateParts[0]);
        return dateObject;
    }

    function fillPage() {
        //update last logged in email
        const userDataIframe = document.getElementById('userdataiframe').contentDocument;
        let email = userDataIframe.getElementById("wf-user-account-email").value;
        if (email) {
            localStorage.setItem("lastLoggedInEmail", email);
        }

        clearTodoItems();
        //load all weeks
        let loadedJSONWeek1 = getMostRecentData("week1");
        let loadedJSONWeek2 = getMostRecentData("week2");
        let loadedJSONWeek3 = getMostRecentData("week3");

// Parse the JSON strings to objects
        let weeks = [
            loadedJSONWeek1 ? JSON.parse(loadedJSONWeek1) : null,
            loadedJSONWeek2 ? JSON.parse(loadedJSONWeek2) : null,
            loadedJSONWeek3 ? JSON.parse(loadedJSONWeek3) : null
        ].filter(week => week !== null); // Filter out any nulls in case of failed data loading

// Sort the weeks by the 'milliseconds' field in descending order
        weeks.sort((a, b) => b.milliseconds - a.milliseconds);

// Now, only consider the week with the largest 'milliseconds' value for comparison
        let activeWeek;
        let today = new Date();
        let lastWeekCutoffDate = new Date();
        lastWeekCutoffDate.setDate(lastWeekCutoffDate.getDate() - 5);

// We use the first element after sorting as it has the largest 'milliseconds' value
        if (weeks.length > 0 && parseDateString(weeks[0].date) > lastWeekCutoffDate) {
            activeWeek = weeks[0];
        }
        if (activeWeek) {
            //if yes, parse it
            weekData.loadSavedData(activeWeek);
            setTodoItems();
            setRatings();
            console.log("Data overwritten from saved data!");
        } else {
            //if no, get the first empty week field or the oldest one
            let weeksUserDataField;
            let week1 = new WeekReflectionData();
            week1.loadSavedData(loadedJSONWeek1 ? JSON.parse(loadedJSONWeek1) : "");
            let week2 = new WeekReflectionData();
            week2.loadSavedData(loadedJSONWeek2 ? JSON.parse(loadedJSONWeek2) : "");
            let week3 = new WeekReflectionData();
            week3.loadSavedData(loadedJSONWeek3 ? JSON.parse(loadedJSONWeek3) : "");
            // if any week is empty, overwrite it
            if (!week3.date) {
                weeksUserDataField = "week3";
            } else if (!week2.date) {
                weeksUserDataField = "week2";
            } else if (!week1.date) {
                weeksUserDataField = "week1";
                // else get oldest week
            } else if (parseDateString(week1.date) < parseDateString(week2.date) && parseDateString(week1.date) < parseDateString(week3.date)) {
                weeksUserDataField = "week1";
            } else if (parseDateString(week2.date) < parseDateString(week1.date) && parseDateString(week2.date) < parseDateString(week3.date)) {
                weeksUserDataField = "week2";
            } else if (parseDateString(week3.date) < parseDateString(week2.date) && parseDateString(week3.date) < parseDateString(week1.date)) {
                weeksUserDataField = "week3";
            }
            let mostRecentWeek;
            //load all days, keep the ones that are max 1 week old
            let dailyCutoffDate = new Date();
            dailyCutoffDate.setDate(dailyCutoffDate.getDate() - 7);
            let days = ["monday", "tuesday", "wednesday", "thursday", "friday", "saturday", "sunday"];
            let thisWeeksDays = [];
            for (const day of days) {
                let loadedJSON = getMostRecentData(day);
                if (loadedJSON && JSON.parse(loadedJSON).date && parseDateString(JSON.parse(loadedJSON).date) > dailyCutoffDate) {
                    let newDay = new DayReflectionData();
                    newDay.loadSavedData(loadedJSON);
                    thisWeeksDays.push(newDay);
                }
            }
            //get most recent week
            if (week1.date && (!week2.date || parseDateString(week1.date) > parseDateString(week2.date)) && (!week3.date || parseDateString(week1.date) > parseDateString(week3.date))) {
                mostRecentWeek = week1;
            } else if (week2.date && (!week1.date || parseDateString(week2.date) > parseDateString(week1.date)) && (!week3.date || parseDateString(week2.date) > parseDateString(week3.date))) {
                mostRecentWeek = week2;
            } else if (week3.date && (!week1.date || parseDateString(week3.date) > parseDateString(week1.date)) && (!week2.date || parseDateString(week3.date) > parseDateString(week2.date))) {
                mostRecentWeek = week3;
            } else {
                mostRecentWeek = new WeekReflectionData();
            }
            //create new week data
            weekData = new WeekReflectionData();
            weekData.userDataField = weeksUserDataField;
            //get old vision from week before
            weekData.previousVision = mostRecentWeek.vision;
            //get open todos from the last day, doesn't have to be within this week
            let mostRecent;
            for (const day of days) {
                let loadedJSON = getMostRecentData(day);
                if (loadedJSON && JSON.parse(loadedJSON).date) {
                    if (!mostRecent) {
                        mostRecent = new DayReflectionData();
                        mostRecent.loadSavedData(loadedJSON);
                    } else if (parseDateString(mostRecent.date) < parseDateString(JSON.parse(loadedJSON).date)) {
                        mostRecent.loadSavedData(loadedJSON);
                    }
                }
            }
            if (mostRecent && mostRecent.todoLists && Array.isArray(mostRecent.todoLists['todo-middle-area-today'])) {
                for (const task of mostRecent.todoLists['todo-middle-area-today']) {
                    task.class = [];
                    addTodoDeletable(todoListNextWeek, task.text);
                    addTodoNonDeletable(todoListOld, task.text);
                }
            }
            //add the tasks from last week that weren't tagged as this week's tasks
            if (mostRecentWeek && mostRecentWeek.todoLists && Array.isArray(mostRecentWeek.todoLists['todo-middle-area-next-week'])) {
                for (const task of mostRecentWeek.todoLists['todo-middle-area-next-week']) {
                    if (!task.class.includes("is-next-weeks-task")) {
                        addTodoDeletable(todoListNextWeek, task.text);
                        addTodoNonDeletable(todoListOld, task.text);
                    }
                }
            }
            updateTodoListData(todoListNextWeek);
            updateTodoListData(todoListOld);

            //get all good and bad notes, include questions, also get finished todos
            let allGoodStuff = [];
            let allBadStuff = [];
            let allFinishedTodos = [];
            for (const day of thisWeeksDays) {
                //special good stuff
                if (day.todoLists["todo-middle-area-good"] && Array.isArray(day.todoLists["todo-middle-area-good"])) {
                    for (const specialGoodEntry of day.todoLists["todo-middle-area-good"]) {
                        let textValue = specialGoodEntry.text;
                        let classValue = specialGoodEntry.class;
                        let promptValue = day.questions["good"];
                        let weekDayValue = day.weekday.charAt(0).toUpperCase() + day.weekday.slice(1);
                        allGoodStuff.push(new GoodOrBadStuff(textValue, classValue, promptValue, weekDayValue));
                    }
                }
                //general good stuff
                if (day.todoLists["todo-middle-area-more-good"] && Array.isArray(day.todoLists["todo-middle-area-more-good"])) {
                    for (const generalGoodEntry of day.todoLists["todo-middle-area-more-good"]) {
                        let textValue = generalGoodEntry.text;
                        let classValue = generalGoodEntry.class;
                        let promptValue = "Good in general:";
                        let weekDayValue = day.weekday.charAt(0).toUpperCase() + day.weekday.slice(1);
                        allGoodStuff.push(new GoodOrBadStuff(textValue, classValue, promptValue, weekDayValue));
                    }
                }
                //special bad stuff
                if (day.todoLists["todo-middle-area-bad"] && Array.isArray(day.todoLists["todo-middle-area-bad"])) {
                    for (const specialBadEntry of day.todoLists["todo-middle-area-bad"]) {
                        let textValue = specialBadEntry.text;
                        let classValue = specialBadEntry.class;
                        let promptValue = day.questions["bad"];
                        let weekDayValue = day.weekday.charAt(0).toUpperCase() + day.weekday.slice(1);
                        allBadStuff.push(new GoodOrBadStuff(textValue, classValue, promptValue, weekDayValue));
                    }
                }
                //general bad stuff
                if (day.todoLists["todo-middle-area-more-bad"] && Array.isArray(day.todoLists["todo-middle-area-more-bad"])) {
                    for (const generalBadEntry of day.todoLists["todo-middle-area-more-bad"]) {
                        let textValue = generalBadEntry.text;
                        let classValue = generalBadEntry.class;
                        let promptValue = "Bad in general:";
                        let weekDayValue = day.weekday.charAt(0).toUpperCase() + day.weekday.slice(1);
                        allBadStuff.push(new GoodOrBadStuff(textValue, classValue, promptValue, weekDayValue));
                    }
                }
                //finished todos, remove duplicates
                if (day.todoLists["todo-middle-area-old"] && Array.isArray(day.todoLists["todo-middle-area-old"])) {
                    for (const todo of day.todoLists["todo-middle-area-old"]) {
                        if (todo.class.includes("is-done")) {
                            if (!allFinishedTodos.map(a => a.text).includes(todo.text)) {
                                allFinishedTodos.push(todo);
                                addTodoDeletable(todoListOld, todo.text, "is-done");
                            }
                        }
                    }
                }
            }
            updateTodoListData(todoListOld);
            weekData.goodStuff = allGoodStuff;
            //if no good stuff, adjust header
            if (weekData.goodStuff.length < 1) {
                document.querySelector("#highlights-header").innerHTML = "Write down all the good stuff that happened this week. Mark your personal highlights:";
            }
            weekData.badStuff = allBadStuff;
            //if no bad stuff, adjust header
            if (weekData.badStuff.length < 1) {
                document.querySelector("#lowlights-header").innerHTML = "Write down all the bad stuff that happened this week. Mark your personal lowlights:";
            }
            weekData.counter = mostRecentWeek.counter ? (mostRecentWeek.counter + 1) : 1;

            //handle first weeklies done tasks
            if (todoListOld.querySelectorAll(".todo_item").length === 0) {
                document.querySelector("#whats-done-prompt").innerText = "Do you already use a task management tool like Asana, Trello, Todoist, phone notes, a physical board, or even just paper for tracking your tasks? If so and it works for you, continue using it. When prompted to manage tasks during reflections, simply update your tasks in your preferred system and skip these steps here. There’s no need to switch systems or manage tasks in multiple places.\n" +
                    "\n" +
                    "However, if you don’t currently use a to-do list or are open to trying something new, this website offers a straightforward task management feature. It’s truly simple: no attachments, due dates, details, or filters. Just a straightforward list of tasks."
            }

            console.log("New data created");
        }

        // set previous Vision if provided
        if (weekData.previousVision) {
            document.querySelector("#previousVision").innerHTML = weekData.previousVision;
        }

        // prep the html
        setGoodAndBadStuff("todo-middle-area-highlight", weekData.goodStuff);
        setGoodAndBadStuff("todo-middle-area-lowlight", weekData.badStuff);


        // remove the mocked summary answers


        initRandom(randomSeed);
        randomizeQuestions(weekData.date, weekData.date);
        // setTodoItems();
        setTextareas();
        setQuestionsInHTML();
        setCounter();
        setButtonLogic();
        //hide loading spinner
        document.getElementsByClassName('loading-spinner')[0].remove();
    }

    function styleCalendarEntry() {
        this.setAttribute("rows", "1");
        if (this.value.length > 0) {
            this.classList.add("calendarevent");
        } else {
            this.classList.remove("calendarevent");
        }
    }

    function autoResize() {
        this.style.height = 'auto';
        this.style.height = this.scrollHeight + 16 + 'px';
    }

    textareas = document.querySelectorAll("[textarea]");
    textareas.forEach(item => {
        item.addEventListener('input', autoResize, false)
    });


    function checkAndSetButtonLogicForSelectableTodoList(todolistId, selectedStateClass, buttonID) {
        if (document.querySelector(todolistId + " ." + selectedStateClass)) {
            showNextButton(buttonID, "Continue");
        } else {
            hideNextButton(buttonID, "Skip >");
        }

        document.querySelector(todolistId).addEventListener("click", (e) => {
            if (document.querySelector(todolistId + " ." + selectedStateClass)) {
                showNextButton(buttonID, "Continue");
            } else {
                hideNextButton(buttonID, "Skip >");
            }
        });
    }

    function checkAndSetButtonLogicForSelectableTodoListCompleted(todolistId, selectedStateClass, buttonID) {
        if (document.querySelectorAll(todolistId + " ." + selectedStateClass)?.length === document.querySelectorAll(todolistId + " .todo_item")?.length) {
            showNextButton(buttonID, "Continue");
        } else {
            hideNextButton(buttonID, "Skip >");
        }

        document.querySelector(todolistId).addEventListener("click", (e) => {
                    if (document.querySelectorAll(todolistId + " ." + selectedStateClass)?.length === document.querySelectorAll(todolistId + " .todo_item")?.length) {
                        showNextButton(buttonID, "Continue");
                    } else {
                        hideNextButton(buttonID, "Skip >");
                    }
            });
    }

    function checkAndSetButtonLogicForRatings(rating, buttonID) {
        if (document.querySelector(rating + " .w--redirected-checked")) {
            showNextButton(buttonID, "Continue");
        } else {
            hideNextButton(buttonID, "Skip >");
        }

        document.querySelectorAll(rating + " input").forEach(function (ratingInput) {
            ratingInput.addEventListener("click", (e) => {
                setTimeout(function () {
                    if (document.querySelector(rating + " .w--redirected-checked")) {
                        showNextButton(buttonID, "Continue");
                    } else {
                        hideNextButton(buttonID, "Skip >");
                    }
                }, 100);
            });
        });
    }

    function checkAndSetButtonLogicForCalendar() {
        var calendarTextareas = [
            "textarea[textarea='600']", "textarea[textarea='615']", "textarea[textarea='630']", "textarea[textarea='645']",
            "textarea[textarea='700']", "textarea[textarea='715']", "textarea[textarea='730']", "textarea[textarea='745']",
            "textarea[textarea='800']", "textarea[textarea='815']", "textarea[textarea='830']", "textarea[textarea='845']",
            "textarea[textarea='900']", "textarea[textarea='915']", "textarea[textarea='930']", "textarea[textarea='945']",
            "textarea[textarea='1000']", "textarea[textarea='1015']", "textarea[textarea='1030']", "textarea[textarea='1045']",
            "textarea[textarea='1100']", "textarea[textarea='1115']", "textarea[textarea='1130']", "textarea[textarea='1145']",
            "textarea[textarea='1200']", "textarea[textarea='1215']", "textarea[textarea='1230']", "textarea[textarea='1245']",
            "textarea[textarea='1300']", "textarea[textarea='1315']", "textarea[textarea='1330']", "textarea[textarea='1345']",
            "textarea[textarea='1400']", "textarea[textarea='1415']", "textarea[textarea='1430']", "textarea[textarea='1445']",
            "textarea[textarea='1500']", "textarea[textarea='1515']", "textarea[textarea='1530']", "textarea[textarea='1545']",
            "textarea[textarea='1600']", "textarea[textarea='1615']", "textarea[textarea='1630']", "textarea[textarea='1645']",
            "textarea[textarea='1700']", "textarea[textarea='1715']", "textarea[textarea='1730']", "textarea[textarea='1745']",
            "textarea[textarea='1800']", "textarea[textarea='1815']", "textarea[textarea='1830']", "textarea[textarea='1845']",
            "textarea[textarea='1900']", "textarea[textarea='1915']", "textarea[textarea='1930']", "textarea[textarea='1945']",
            "textarea[textarea='2000']", "textarea[textarea='2015']", "textarea[textarea='2030']", "textarea[textarea='2045']",
            "textarea[textarea='2100']", "textarea[textarea='2115']", "textarea[textarea='2130']", "textarea[textarea='2145']",
            "textarea[textarea='2200']", "textarea[textarea='2215']", "textarea[textarea='2230']", "textarea[textarea='2245']",
            "textarea[textarea='2300']", "textarea[textarea='2315']", "textarea[textarea='2330']", "textarea[textarea='2345']",
        ];
        for (const entry of calendarTextareas) {
            setTimeout(function () {
                document.querySelector(entry).dispatchEvent(new Event("input"));
            }, 1000);
        }
        checkAndSetButtonLogicForTextarea(calendarTextareas, "#step4");
    }

    function showNextButton(button, label) {
        document.querySelector(button).classList.remove("step-incomplete");
        document.querySelector(button).innerHTML = label;
    }

    function hideNextButton(button, label) {
        document.querySelector(button).classList.add("step-incomplete");
        document.querySelector(button).innerHTML = label;
    }

    function setButtonLogic() {
        //step1 slide1
        checkAndSetButtonLogicForSelectableTodoList("#todo-middle-area-highlight", "is-highlight", "#step1-slide1");
        //step1 slide2
        checkAndSetButtonLogicForSelectableTodoList("#todo-middle-area-lowlight", "is-lowlight", "#step1-slide2");
        //step2 slide1
        checkAndSetButtonLogicForRatings("#rating-previous-vision", "#step2-slide1");
        //step2 slide2
        checkAndSetButtonLogicForRatings("#rating-sleep", "#step2-slide2");
        //step2 slide3
        checkAndSetButtonLogicForRatings("#rating-nutrition", "#step2-slide3");
        //step2 slide4
        checkAndSetButtonLogicForRatings("#rating-physical", "#step2-slide4");
        //step2 slide5
        checkAndSetButtonLogicForRatings("#rating-mental", "#step2-slide5");
        //step2 slide6
        checkAndSetButtonLogicForRatings("#rating-love", "#step2-slide6");
        //step2 slide7
        checkAndSetButtonLogicForRatings("#rating-family", "#step2-slide7");
        //step2 slide8
        checkAndSetButtonLogicForRatings("#rating-friends", "#step2-slide8");
        //step2 slide9
        checkAndSetButtonLogicForRatings("#rating-mission", "#step2-slide9");
        //step2 slide10
        checkAndSetButtonLogicForRatings("#rating-fun", "#step2-slide10");
        //step2 slide11
        checkAndSetButtonLogicForRatings("#rating-finances", "#step2-slide11");
        //step2 slide12
        checkAndSetButtonLogicForRatings("#rating-learning", "#step2-slide12");
        //step3 slide1
        checkAndSetButtonLogicForTodo(["#todo-middle-area-good-grateful .todo-label"], "#step3-slide1", ["#wf-form-Add-Form-Good-Grateful"]);
        //step3 slide2
        checkAndSetButtonLogicForTodo(["#todo-middle-area-good-repeat .todo-label"], "#step3-slide2", ["#wf-form-Add-Form-Good-Repeat"]);
        //step3 slide3
        checkAndSetButtonLogicForTodo(["#todo-middle-area-bad-complain .todo-label"], "#step3-slide3", ["#wf-form-Add-Form-Bad-Complain"]);
        //step3 slide4
        checkAndSetButtonLogicForTodo(["#todo-middle-area-bad-improve .todo-label"], "#step3-slide4", ["#wf-form-Add-Form-Bad-Improve"]);
        //step4 slide1
        checkAndSetButtonLogicForTodo(["#todo-middle-area-calendar .todo-label"], "#step4", ["#wf-form-Add-Form-Calendar"]);
        //step5 slide1
        checkAndSetButtonLogicForSelectableTodoList("#todo-middle-area-old", "is-done", "#step5-slide1");
        //step5 slide2
        checkAndSetButtonLogicForSelectableTodoList("#todo-middle-area-next-week", "is-next-weeks-task", "#step5-slide2");
        //step5 slide3
        checkAndSetButtonLogicForSelectableTodoListCompleted("#todo-middle-area-improve-goals", "is-finalized-task", "#step5-slide3");
        //step6 slide1
        checkAndSetButtonLogicForTextarea(["textarea[textarea='vision']"], "#step6-slide1");
        //step6 slide2
        checkAndSetButtonLogicForTextarea(["textarea[textarea='custom']"], "#step6-slide2");
    }

    function checkAndSetButtonLogicForTextarea(fields, button) {
        let hasValue = false;
        for (const entry of fields) {
            if (document.querySelector(entry).value) {
                hasValue = true;
            }
            document.querySelector(entry).addEventListener('input', function (e) {
                hideButtonForTextarea(e, fields, button);
            }, false);
            setTimeout(function () {
                document.querySelector(entry).dispatchEvent(new Event("input"));
            }, 1000);
        }
        if (!hasValue) {
            hideNextButton(button, "Skip >");
        }
    }

    function hideButtonForTextarea(event, fields, button) {
        let hasValue = false;
        for (const entry of fields) {
            if (document.querySelector(entry).value) {
                hasValue = true;
            }
        }
        if (!hasValue) {
            hideNextButton(button, "Skip >");
        } else {
            showNextButton(button, "Continue");
        }
    }

    function checkAndSetButtonLogicForTodo(fields, button, forms) {
        let hasValue = false;
        for (const entry of fields) {
            if (document.querySelector(entry)?.innerHTML) {
                hasValue = true;
            }
        }
        for (const form of forms) {
            document.querySelector(form + " input").addEventListener('input', function (e) {
                hideButtonForTodo(e, fields, button, forms);
            }, false);
        }
        if (!hasValue) {
            hideNextButton(button, "Skip >");
        }
    }

    function hideButtonForTodo(event, fields, button, forms) {
        let hasValue = false;
        for (const entry of fields) {
            if (document.querySelector(entry)?.innerHTML) {
                hasValue = true;
            }
        }
        for (const form of forms) {
            if (document.querySelector(form + " input").value) {
                hasValue = true;
            }
        }
        if (!hasValue) {
            hideNextButton(button, "Skip >");
        } else {
            showNextButton(button, "Continue");
        }
    }

    function onVisible(element, callback) {
        new IntersectionObserver((entries, observer) => {
            entries.forEach(entry => {
                if (entry.intersectionRatio > 0) {
                    callback(element);
                    observer.disconnect();
                }
            });
        }).observe(element);
        if (!callback) return new Promise(r => callback = r);
    }

    //start
    try {
        var dayData = new DayReflectionData();
        var weekData = new WeekReflectionData()
        var randomSeed = dayData.date + dayData.weekday;

        // remove the mocked item from Summary Fields
        let summaries = document.querySelectorAll(".goodsummary, .badsummary");
        summaries.forEach(function (summary) {
            summary.querySelectorAll(".central-text").forEach(function (item) {
                item.remove();
            });
            summary.classList.add("hidden")
        });


        waitFor(_ => document.getElementById('userdataiframe').contentDocument).then(
            _ => waitFor(_ => document.getElementById('userdataiframe').contentDocument.getElementById('wf-user-account-email')).then(
                _ => waitFor(_ => document.getElementById('userdataiframe').contentDocument.getElementById('wf-user-account-email').value).then(
                    _ => fillPage(dayData, randomSeed))));


        // save data to cookies
        const buttonsForCookies = document.querySelectorAll(".w-button");
        buttonsForCookies.forEach(function (element) {
            element.addEventListener("click", (e) => {
                backupToLocalStorage(weekData.userDataField, JSON.stringify(weekData));
                console.log('cookie data updated');
            });
        });

        // save data to userdata
        const buttons = document.querySelectorAll(".triggers-save");
        buttons.forEach(function (element) {
            element.addEventListener("click", (e) => {
                var iframe = document.getElementById('userdataiframe').contentDocument;
                if (iframe.getElementById(weekData.userDataField).value !== JSON.stringify(weekData)) {
                    console.log('user data updated');
                    iframe.getElementById(weekData.userDataField).value = JSON.stringify(weekData);
                    iframe.querySelector(".w-users-useraccountformsavebutton").click();
                }
            });
        });

    } catch (error) {
        console.log(error);

    }

    function saveToData() {
        if (this.getAttribute("textarea") === "vision") {
            weekData.vision = this.value;
        } else if (this.getAttribute("textarea") === "custom") {
            weekData.customQuestion = this.value;
        }
    }

    function backupToLocalStorage(name, value) {
        // Directly storing the value without URI encoding
        name+=localStorage.getItem("lastLoggedInEmail");
        localStorage.setItem(name, value);
    }

    function getLocalStorageBackup(name) {
        name+=localStorage.getItem("lastLoggedInEmail");
        let storedValue = localStorage.getItem(name);
        return storedValue ? decodeURIComponent(storedValue) : "";
    }

    function getMostRecentData(name) {
        const userDataIframe = document.getElementById('userdataiframe').contentDocument;
        let loadedUserDataJSON = userDataIframe.getElementById(name).value;
        let loadedCookieJSON = getLocalStorageBackup(name);

        //if all are empty return something, doesn't matter
        if (!isJsonString(loadedUserDataJSON) && !isJsonString(loadedCookieJSON)) {
            return loadedUserDataJSON;
        }
        //if one is empty, return the other
        if (isJsonString(loadedUserDataJSON) && !isJsonString(loadedCookieJSON)) {
            return loadedUserDataJSON;
        }
        if (!isJsonString(loadedUserDataJSON) && isJsonString(loadedCookieJSON)) {
            return loadedCookieJSON;
        }

        let parsedUserData = JSON.parse(loadedUserDataJSON);
        let parsedCookie = JSON.parse(loadedCookieJSON);

        if (parsedUserData.milliseconds > parsedCookie.milliseconds) {
            return loadedUserDataJSON;
        } else {
            return loadedCookieJSON;
        }
    }

    function isJsonString(str) {
        try {
            JSON.parse(str);
        } catch (e) {
            return false;
        }
        return true;
    }


</script>
