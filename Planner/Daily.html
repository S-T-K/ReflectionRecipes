<script>

    class DayReflectionData  {
        date;
        weekday;
        questions;
        inputs;
        todoLists;
        constructor() {
            this.date = getCurrentDate();
            let days = ["sunday", "monday", "tuesday", "wednesday","thursday", "friday","saturday"];
            this.weekday = days[new Date().getDay()];
            this.questions = {};
            this.inputs = {};
            this.todoLists = {};
        }

        loadSavedData(string) {
            let parsed = JSON.parse(string);
            this.date = parsed.date;
            this.weekday = parsed.weekday;
            this.questions = parsed.questions;
            this.inputs = parsed.inputs;
            this.todoLists = parsed.todoLists;
        }
    }

    class todoListItem {
        text;
        class;
        constructor(textValue, classValue) {
            this.text = textValue;
            this.class = classValue;
        }
    }
    function setCookie(cname, cvalue, exdays) {
        const d = new Date();
        d.setTime(d.getTime() + (exdays*24*60*60*1000));
        let expires = "expires="+ d.toUTCString();
        document.cookie = cname + "=" + encodeURIComponent(cvalue) + ";" + expires + ";path=/";
    }

    function getCookie(cname) {
        let name = cname + "=";
        let decodedCookie = decodeURIComponent(document.cookie);
        let ca = decodedCookie.split(';');
        for(let i = 0; i <ca.length; i++) {
            let c = ca[i];
            while (c.charAt(0) == ' ') {
                c = c.substring(1);
            }
            if (c.indexOf(name) == 0) {
                return c.substring(name.length, c.length);
            }
        }
        return "";
    }

    function cyrb128(str) {
        let h1 = 1779033703, h2 = 3144134277,
            h3 = 1013904242, h4 = 2773480762;
        for (let i = 0, k; i < str.length; i++) {
            k = str.charCodeAt(i);
            h1 = h2 ^ Math.imul(h1 ^ k, 597399067);
            h2 = h3 ^ Math.imul(h2 ^ k, 2869860233);
            h3 = h4 ^ Math.imul(h3 ^ k, 951274213);
            h4 = h1 ^ Math.imul(h4 ^ k, 2716044179);
        }
        h1 = Math.imul(h3 ^ (h1 >>> 18), 597399067);
        h2 = Math.imul(h4 ^ (h2 >>> 22), 2869860233);
        h3 = Math.imul(h1 ^ (h3 >>> 17), 951274213);
        h4 = Math.imul(h2 ^ (h4 >>> 19), 2716044179);
        return [(h1^h2^h3^h4)>>>0, (h2^h1)>>>0, (h3^h1)>>>0, (h4^h1)>>>0];
    }

    function sfc32(a, b, c, d) {
        return function() {
            a >>>= 0; b >>>= 0; c >>>= 0; d >>>= 0;
            var t = (a + b) | 0;
            a = b ^ b >>> 9;
            b = c + (c << 3) | 0;
            c = (c << 21 | c >>> 11);
            d = d + 1 | 0;
            t = t + d | 0;
            c = c + t | 0;
            return (t >>> 0) / 4294967296;
        }
    }


    function populateWeightedQuestions(questions, weights) {
        var weightedQuestions = new Array();

        for (var i = 0; i < questions.length; i++) {
            for (var j = 0; j < weights[i]; j++) {
                weightedQuestions.push(questions[i]);
            }
        }
        return weightedQuestions;
    }

    function getRandomQuestion(questions, weights) {
        var weightedQuestions = populateWeightedQuestions(questions, weights)
        return weightedQuestions[Math.floor(Math.random() * weightedQuestions.length)];
    }

    function setQuestion(week, day, question, selector) {
        // check for stored questions
        var storedQuestion = getCookie(selector+week+day);
        if (storedQuestion.length > 0) {
            question = storedQuestion
        } else {
            setCookie(selector+week+day, question, 999);
        }
        setQuestionData(question, selector);
    }

    function setQuestionData(question, selector) {
        dayData.questions[selector] = question;
    }

    function setQuestionsInHTML() {
        for (let [key, value] of Object.entries(dayData.questions)) {
            const element = document.querySelector('[question="' + key + '"]');
            element.innerHTML = value;
        }
    }

    function setRandomQuestion(week, day, questions, weights, selector) {
        const question = getRandomQuestion(questions, weights);
        setQuestion(week, day, question, selector);
    }

    function setRandomQuestionPair(week, day, questions, questions2, weights, selector, selector2) {
        var weightedQuestions = populateWeightedQuestions(questions, weights);
        var weightedQuestions2 = populateWeightedQuestions(questions2, weights);

        var randomNumber = Math.floor(Math.random() * weightedQuestions.length);
        setQuestion(week, day, weightedQuestions[randomNumber], selector);
        setQuestion(week, day, weightedQuestions2[randomNumber], selector2);
    }

    function randomizeQuestions(week, day) {

        var questions = new Array();
        var weights = new Array();
        questions.push("One thing I can get excited about today:");
        weights.push(1);
        questions.push("One thing I want to learn today is:");
        weights.push(1);
        questions.push("One thing that I want to do today because I enjoy it is:");
        weights.push(1);
        questions.push("One thing I'm proud of is:");
        weights.push(1);
        questions.push("What am I grateful for today?");
        weights.push(1);
        questions.push("How will I enjoy myself today?");
        weights.push(1);
        questions.push("What did I learn from yesterday?");
        weights.push(1);
        questions.push("How will I create value today?");
        weights.push(1);
        questions.push("What am I happy about in my life right now?");
        weights.push(1);
        questions.push("What am I excited about in my life in general?");
        weights.push(1);
        questions.push("Something that will make today special is:");
        weights.push(1);
        questions.push("A habit of mine that is very valuable is:");
        weights.push(1);

        setRandomQuestion(week, day, questions, weights, "outlook");

        questions = new Array();
        weights = new Array();
        questions.push("The person I want to be today is:");
        weights.push(1);
        questions.push("How do I want to feel at the end of the day?");
        weights.push(1);
        questions.push("What would my ideal version do today?");
        weights.push(1);
        questions.push("Which question do I want to have answered by the end of the day?");
        weights.push(1);
        questions.push("What will be my main focus?");
        weights.push(1);
        questions.push("How do I want to feel today?");
        weights.push(1);
        questions.push("How will I grow today?");
        weights.push(1);
        questions.push("What will I do better today?");
        weights.push(1);
        questions.push("Something I want to be proud of at the end of the day is:");
        weights.push(1);
        questions.push("What does my soul need today?");
        weights.push(1);
        questions.push("What would make today a great day?");
        weights.push(1);
        questions.push("A strength of mine that will be of great use today is:");
        weights.push(1);

        setRandomQuestion(week, day, questions, weights, "visualization");

        questions = new Array();
        weights = new Array();
        var questions2 = new Array();
        questions.push("A situation that could stress me out today is:");
        weights.push(1);
        questions2.push("… and how I will deal with it is:")
        questions.push("A small, yet valuable task I could do today is:");
        weights.push(1);
        questions2.push("… and how I will reward myself for completing it is:")
        questions.push("Something I'm not currently doing, even though I should:");
        weights.push(1);
        questions2.push("… and how I will make sure to do it today is:")
        questions.push("How do I feel right now?");
        weights.push(1);
        questions2.push("… and what is this emotion trying to tell me?")
        questions.push("What causes me to feel stressed lately?");
        weights.push(1);
        questions2.push("… and what can I do about it?")
        questions.push("When do I waste time throughout the day?");
        weights.push(1);
        questions2.push("… and what can I do to change that?")
        questions.push("One of my values I've been neglecting lately is:");
        weights.push(1);
        questions2.push("… and how I will live in alignment with it today is:")
        questions.push("What am I avoiding?");
        weights.push(1);
        questions2.push("… and how will I face this fear today?")
        questions.push("What would I do with an extra hour of time today?");
        weights.push(1);
        questions2.push("… and how can I do it anyway?")
        questions.push("One thing I'd rather not do today is:");
        weights.push(1);
        questions2.push("… and would my best self do it?")
        questions.push("A weakness of mine that could be harmful today is:");
        weights.push(1);
        questions2.push("… and what I will do to limit the harm done is:")
        questions.push("A bad habit of mine is:");
        weights.push(1);
        questions2.push("… and what I will replace it with today is:")
        questions.push("Something I think will be a waste of time today is:");
        weights.push(1);
        questions2.push("… and how I can gain something from it, or prevent it:")
        questions.push("The three most valuable tasks of today are:");
        weights.push(1);
        questions2.push("… and how I can make sure to focus on them is:")
        questions.push("Someone I look up to is:");
        weights.push(1);
        questions2.push("… and what they would do today is:")
        questions.push("What's the biggest obstacle I'm facing at the moment?");
        weights.push(1);
        questions2.push("… and how I will grow from it is:")

        setRandomQuestionPair(week, day, questions, questions2, weights, "prevention1", "prevention2");

        questions = new Array();
        weights = new Array();
        questions.push("A bold/important action I could do today is: ");
        weights.push(1);
        questions.push("The single most important task today is:");
        weights.push(1);
        questions.push("How could I inspire myself to do something bold today?");
        weights.push(1);
        questions.push("A long-term goal I will work on today is:");
        weights.push(1);
        questions.push("What would I do if I knew I would succeed? ");
        weights.push(1);
        questions.push("In what way do I want to excel today?");
        weights.push(1);
        questions.push("What did I wake up for today?");
        weights.push(1);
        questions.push("How will I step outside of my comfort zone today?");
        weights.push(1);
        questions.push("What important task am I committed to completing today?");
        weights.push(1);
        questions.push("What can I prepare today?");
        weights.push(1);
        questions.push("If I were my own coach, which advice would I give myself today?");
        weights.push(1);
        questions.push("Which action would have a positive impact even in a year?");
        weights.push(1);
        questions.push("A bold idea I could start working on today is:");
        weights.push(1);
        questions.push("Something I neet to stop or say no to is:");
        weights.push(1);
        questions.push("Something my most authentic self would do today is:");
        weights.push(1);

        setRandomQuestion(week, day, questions, weights, "boldness");

        questions = new Array();
        weights = new Array();
        questions.push("Someone I could surprise/lead/connect with today is:");
        weights.push(1);
        questions.push("How can I be loving today?");
        weights.push(1);
        questions.push("Someone I will tell how much I appreciate them is:");
        weights.push(1);
        questions.push("Which positive people could I surround myself with today?");
        weights.push(1);
        questions.push("How will I be of service today?");
        weights.push(1);
        questions.push("Which people in my life am I taking for granted?");
        weights.push(1);
        questions.push("Who can I forgive today?");
        weights.push(1);
        questions.push("Who can I appreciate today?");
        weights.push(1);
        questions.push("Who can I help today?");
        weights.push(1);
        questions.push("Who do I love? Who loves me?");
        weights.push(1);
        questions.push("Who is going to help me today?");
        weights.push(1);
        questions.push("What could I teach someone today?");
        weights.push(1);
        questions.push("Someone I wish would reach out to me today is:");
        weights.push(1);

        setRandomQuestion(week, day, questions, weights, "social");

        questions = new Array();
        weights = new Array();
        questions.push("On a scale from 1-10, yesterday was:");
        weights.push(1);
        questions.push("A word that would describe yesterday is:");
        weights.push(1);
        questions.push("Compared to an average day lately, yesterday was:");
        weights.push(1);
        questions.push("Yesterday summarized in a simple drawing/emoji:");
        weights.push(1);
        questions.push("Yesterday's primary emotion was:");
        weights.push(1);

        setRandomQuestion(week, day, questions, weights, "summary");

        questions = new Array();
        weights = new Array();
        questions.push("A positive moment I remember was:");
        weights.push(1);
        questions.push("Something I handled well was:");
        weights.push(1);
        questions.push("A situation I would'nt change anything about was:");
        weights.push(1);
        questions.push("Something I learned yesterday was:");
        weights.push(1);
        questions.push("I was proud of myself when:");
        weights.push(1);
        questions.push("Yesterday's highlight was:");
        weights.push(1);
        questions.push("What were my wins yesterday?");
        weights.push(1);
        questions.push("What moments am I grateful for?");
        weights.push(1);
        questions.push("A challenge I handled well was:");
        weights.push(1);
        questions.push("My favourite memory from yesterday was:");
        weights.push(1);

        setRandomQuestion(week, day, questions, weights, "good");


        questions = new Array();
        weights = new Array();
        questions.push("A negative situation I remember was:");
        weights.push(1);
        questions.push("Something I could have done better was:");
        weights.push(1);
        questions.push("A simple thing that would have made yesterday better was:");
        weights.push(1);
        questions.push("A missed opportunity yesterday was:");
        weights.push(1);
        questions.push("Something that would have helped me yesterday was:");
        weights.push(1);
        questions.push("I was wasting time/energy when:");
        weights.push(1);
        questions.push("What didn't work as expected?");
        weights.push(1);
        questions.push("How did my emotions/feelings work against me?");
        weights.push(1);
        questions.push("When did I encounter resistance?");
        weights.push(1);
        questions.push("I got stuck when:");
        weights.push(1);
        questions.push("Regrets I have about yesterday:");
        weights.push(1);
        questions.push("Could I have been more productive?");
        weights.push(1);
        questions.push("Could I have been less stressed out?");
        weights.push(1);
        questions.push("Could I have been more loving toward the people around me?");
        weights.push(1);
        questions.push("The hardest thing about yesterday was:");
        weights.push(1);

        setRandomQuestion(week, day, questions, weights, "bad");
    }

    function initRandom(randomSeed) {
// Create cyrb128 state:
        var seed = cyrb128(randomSeed);
// Four 32-bit component hashes provide the seed for sfc32.
        var rand = sfc32(seed[0], seed[1], seed[2], seed[3]);
        Math.random = rand;
    }

    function getCurrentDate() {
        var today = new Date();
        var dd = String(today.getDate()).padStart(2, '0');
        var mm = String(today.getMonth() + 1).padStart(2, '0'); //January is 0!
        var yyyy = today.getFullYear();

        return dd + '-' + mm + '-' + yyyy;
    }

    const addInputGood = document.querySelector("#wf-form-Add-Form-good");
    const todoListGood = document.querySelector("#todo-middle-area-good");
    const addInputGoodMore = document.querySelector("#wf-form-Add-Form-more-good");
    const todoListGoodMore = document.querySelector("#todo-middle-area-more-good");
    const addInputBadMore = document.querySelector("#wf-form-Add-Form-more-bad");
    const todoListBadMore = document.querySelector("#todo-middle-area-more-bad");
    const addInputBad = document.querySelector("#wf-form-Add-Form-bad");
    const todoListBad = document.querySelector("#todo-middle-area-bad");
    const addInputOld = document.querySelector("#wf-form-Add-Form-old");
    const todoListOld = document.querySelector("#todo-middle-area-old");
    const addInputToday = document.querySelector("#wf-form-Add-Form-today");
    const todoListToday = document.querySelector("#todo-middle-area-today");
    const todoInputsDeletable = [addInputGood, addInputGoodMore, addInputBadMore, addInputBad, addInputToday];
    const todoListsDeletable = [todoListGood, todoListGoodMore, todoListBadMore, todoListBad, todoListToday]
    const todoInputsNonDeletable = [addInputOld];
    const todoListsNonDeletable = [todoListOld];


    function updateTodoListData(list) {
        let listSelector = list.id;
        console.log(listSelector);
        let items = list.querySelectorAll(".todo-label");
        let values = [];
        items.forEach(function (item) {
            let classList = Array.from(item.parentElement.classList);
            console.log("classList before shift: " + classList);
            classList.shift();
            console.log("classList after shift: " + classList);
            values.push(new todoListItem(item.innerText, classList));
        });
        console.log(values);
        dayData.todoLists[listSelector] = values;
    }

    const addTodoDeletable = (list, todo, classString) => {
        let classStringTotal = "todo_item";
        if (classString) {
            classStringTotal += " " + classString;
        }
        const htmlContent = `
             <div class="${classStringTotal}">
                <div class="pointer-none todo-label">${todo}</div>
                <div class="svg-icon trash-icon w-embed">
                  <svg
                    class="pointer-none"
                    width="24"
                    height="25"
                    viewbox="0 0 24 25"
                    fill="none"
                    xmlns="http://www.w3.org/2000/svg"
                  >
                    <path
                      d="M3 6.5H5H21"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    ></path>
                    <path
                      d="M8 6.5V4.5C8 3.96957 8.21071 3.46086 8.58579 3.08579C8.96086 2.71071 9.46957 2.5 10 2.5H14C14.5304 2.5 15.0391 2.71071 15.4142 3.08579C15.7893 3.46086 16 3.96957 16 4.5V6.5M19 6.5V20.5C19 21.0304 18.7893 21.5391 18.4142 21.9142C18.0391 22.2893 17.5304 22.5 17 22.5H7C6.46957 22.5 5.96086 22.2893 5.58579 21.9142C5.21071 21.5391 5 21.0304 5 20.5V6.5H19Z"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    ></path>
                  </svg>
                </div>
              </div>
`;
        console.log("test classlist");
        console.log(htmlContent.classList);
        list.innerHTML += htmlContent;
    };
    const addTodoNonDeletable = (list, todo, classString) => {
        let classStringTotal = "todo_item";
        if (classString) {
            classStringTotal += " " + classString;
        }
        const htmlContent = `
             <div class="${classStringTotal}">
                <div class="pointer-none todo-label">${todo}</div>
              </div>
`;
        list.innerHTML += htmlContent;
    };

    //add item on submit deletable
    todoInputsDeletable.forEach(function (element, index) {
        element.addEventListener("submit", (e) => {
            e.preventDefault();
            const input = element.AddTerm.value.trim();

            if (input.length) {
                addTodoDeletable(todoListsDeletable[index], input);
                updateTodoListData(todoListsDeletable[index]);
                element.reset();
            }
        });
    });

    //add item on submit non deletable
    todoInputsNonDeletable.forEach(function (element, index) {
        element.addEventListener("submit", (e) => {
            e.preventDefault();
            const input = element.AddTerm.value.trim();

            if (input.length) {
                addTodoNonDeletable(todoListsNonDeletable[index], input);
                updateTodoListData(todoListsNonDeletable[index]);
                element.reset();
            }
        });
    });

    //add item on blur deletable
    todoInputsDeletable.forEach(function (element, index) {
        element.AddTerm.onblur = function(){
            const input = element.AddTerm.value.trim();

            if (input.length) {
                addTodoDeletable(todoListsDeletable[index], input);
                updateTodoListData(todoListsDeletable[index]);
                element.reset();
            }
        }
    });

    //add item on blur non deletable
    todoInputsNonDeletable.forEach(function (element, index) {
        element.AddTerm.onblur = function(){
            const input = element.AddTerm.value.trim();

            if (input.length) {
                addTodoNonDeletable(todoListsNonDeletable[index], input);
                updateTodoListData(todoListsNonDeletable[index]);
                element.reset();
            }
        }
    });

    //delete items
    todoListsDeletable.forEach(function (element, index) {
        element.addEventListener("click", (e) => {
            if (e.target.parentElement.parentElement.classList.contains("trash-icon")) {
                e.target.parentElement.parentElement.parentElement.remove();
                updateTodoListData(todoListsDeletable[index]);
            } else if (e.target.parentElement.classList.contains("trash-icon")) {
                e.target.parentElement.parentElement.remove();
                updateTodoListData(todoListsDeletable[index]);
            } else if (e.target.classList.contains("trash-icon")) {
                e.target.parentElement.remove();
                updateTodoListData(todoListsDeletable[index]);
            }
        });
    });

    //Cross out Items
    todoListOld.addEventListener("click", (e) => {
        let todo = "";
        if (e.target.classList.contains("todo_item")) {
            e.target.classList.toggle("is-done");
            updateTodoListData(todoListOld);
            todo = e.target.firstElementChild.innerHTML;
        } else if (e.target.parentElement.classList.contains("todo_item")) {
            e.target.parentElement.classList.toggle("is-done");
            updateTodoListData(todoListOld);
            todo = e.target.innerHTML;
        }
        // remove from today's tasks
        if (e.target.classList.contains("is-done") || e.target.parentElement.classList.contains("is-done")) {
            for (const a of todoListToday.querySelectorAll(".todo_item")) {
                if (a.children[0].textContent === todo) {
                    a.parentElement.removeChild(a);
                    updateTodoListData(todoListToday);
                }
                }
        // add to today's tasks
        } else {
            addTodoNonDeletable(todoListToday, todo);
        }
        updateTodoListData(todoListToday);

    });

    //Mark as today's task
    todoListToday.addEventListener("click", (e) => {
        if (e.target.classList.contains("todo_item")) {
            e.target.classList.toggle("is-todays-task");
            updateTodoListData(todoListToday);
        } else if (e.target.parentElement.classList.contains("todo_item")) {
            e.target.parentElement.classList.toggle("is-todays-task");
            updateTodoListData(todoListToday);
        }
    });

    function waitFor(conditionFunction) {
        const poll = resolve => {
            if(conditionFunction()) resolve();
            else setTimeout(_ => poll(resolve), 500);
        }
        return new Promise(poll);
    }
    function waitForElm(element) {
        return new Promise(resolve => {
            if (element) {
                return resolve(element);
            }

            const observer = new MutationObserver(mutations => {
                if (element) {
                    resolve(element);
                    observer.disconnect();
                }
            });

            observer.observe(document.body, {
                childList: true,
                subtree: true
            });
        });
    }

    function setTodoItems() {
// dayData has a list of todoLists based on selectors. create a method that
        // adds a new item to a todolist without writing it to data. also consider the state of the todo
        for (let [key, value] of Object.entries(dayData.todoLists)) {
            let element = document.querySelector("#" + key);
            console.log("tried to set todo Items for:")
            console.log(element);
            value.forEach( function (item) {
if (todoListsDeletable.includes(element)) {
    addTodoDeletable(element, item.text, item.class[0]);
} else if (todoListsNonDeletable.includes(element)) {
    addTodoNonDeletable(element, item.text, item.class[0]);
}
            });
        }
    }

    function onVisible(element, callback) {
        new IntersectionObserver((entries, observer) => {
            entries.forEach(entry => {
                if(entry.intersectionRatio > 0) {
                    callback(element);
                    observer.disconnect();
                }
            });
        }).observe(element);
    }

    function setTextareas() {
//        // maybe add the height of calendar entries to their data (in the resize method that is missing) and then also set
        //it when loading them
        document.querySelectorAll("textarea[textarea]").forEach(function (textarea) {
            if (dayData.inputs[textarea.getAttribute("textarea")]) {
                textarea.value = dayData.inputs[textarea.getAttribute("textarea")];
                // to resize them properly
                onVisible(textarea, (element) => {
                        console.log("it's visible");
                        element.style.height = 'auto';
                        element.style.height = element.scrollHeight + 'px';
                    }
                    );
            }
            }
        );
    }

    function clearTodoItems() {
        //clear all todolists so I can keep them filled to test the styling
       todoListsDeletable.forEach(function (todoList) {
            todoList.innerHTML = "";
            }
        );
        todoListsNonDeletable.forEach(function (todoList) {
                todoList.innerHTML = "";
            }
        );
    }

    function parseDateString (dateString) {
        var dateParts = dateString.split("-");
// month is 0-based, that's why we need dataParts[1] - 1
        var dateObject = new Date(+dateParts[2], dateParts[1] - 1, +dateParts[0]);
        return dateObject;
    }

    function fillPage() {
        console.log("Data loaded!");
        const userDataIframe = document.getElementById('userdataiframe').contentDocument;
        console.log(userDataIframe.getElementById(dayData.weekday).value);
        clearTodoItems();
        let loadedJSONToday = userDataIframe.getElementById(dayData.weekday).value;
        if (loadedJSONToday && JSON.parse(loadedJSONToday).date === dayData.date) {
            dayData.loadSavedData(userDataIframe.getElementById(dayData.weekday).value);
            console.log("Data overwritten from saved data!");
        } else {
            // get todos from yesterday or any day before
            let days = ["sunday", "monday", "tuesday", "wednesday","thursday", "friday","saturday"];
            let mostRecent;
            for (const day of days) {
                let loadedJSON = userDataIframe.getElementById(day).value;
                if (loadedJSON && JSON.parse(loadedJSON).date && dayData.date !== JSON.parse(loadedJSON).date) {
                    if (!mostRecent) {
                        mostRecent = new DayReflectionData();
                        mostRecent.loadSavedData(loadedJSON);
                    } else if (parseDateString(mostRecent.date) > parseDateString(JSON.parse(loadedJSON).date)) {
                        mostRecent.loadSavedData(loadedJSON);
                    }
                }
            }

            initRandom(randomSeed);
            randomizeQuestions(dayData.date, dayData.weekday);
            console.log("New data created because dates didn't match");
        }
        setTodoItems();
        setTextareas();
        setQuestionsInHTML();
    }

    function styleCalendarEntry() {
        if (this.value.length > 0) {
            this.classList.add("calendarevent");
        } else {
            this.classList.remove("calendarevent");
        }
    }

    function autoResize() {
        this.style.height = 'auto';
        this.style.height = this.scrollHeight + 'px';
    }

    textareas = document.querySelectorAll("[textarea]");
    textareas.forEach(item => {item.addEventListener('input', saveToData, false)});
    textareas.forEach(item => {item.addEventListener('input', autoResize, false)});
    calendarTextareas = document.querySelectorAll(".textareaquarter");
    calendarTextareas.forEach(item => {
        item.addEventListener('input', styleCalendarEntry, false);
        onVisible(item, (element) => {
                console.log("calendars visible");
            if (element.value.length > 0) {
                element.classList.add("calendarevent");
            } else {
                element.classList.remove("calendarevent");
            }
            }
        );
    });

// start

    var dayData = new DayReflectionData();
    var randomSeed = dayData.date+dayData.weekday;



    waitFor(_ => document.getElementById('userdataiframe').contentDocument).then(
        _ => waitFor(_ => document.getElementById('userdataiframe').contentDocument.getElementById('wf-user-account-email')).then(
            _ => waitFor(_ => document.getElementById('userdataiframe').contentDocument.getElementById('wf-user-account-email').value).then(
                _ => fillPage())));


    //test section

    const buttons = document.querySelectorAll(".w-button");
    console.log(buttons);
    buttons.forEach(function (element) {
        element.addEventListener("click", (e) => {
            var iframe = document.getElementById('userdataiframe').contentDocument;
            console.log(iframe);
            iframe.getElementById(dayData.weekday).value = JSON.stringify(dayData);
            iframe.querySelector(".w-users-useraccountformsavebutton").click();
        });
    });


    function saveToData() {
        console.log("saving to data: " +  this.value);
        dayData.inputs[this.getAttribute("textarea")] = this.value;
    }


</script>
